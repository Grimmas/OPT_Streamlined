// B9 Tank Switch for OPT Spaceplane
// Author: JadeOfMaar

// Removes dependency on Firespitter.
// OPT Night Mode not supported.

// =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  
B9_TANK_TYPE:NEEDS[B9PartSwitch,!ConfigurableContainers,!Pathfinder,!ModularFuelTanks,!RealFuels]
{
	name = OPTLF
	tankMass = 0.0003
	tankCost = 0.25
	RESOURCE
	{
		name = LiquidFuel
		unitsPerVolume = 1
	}
}
B9_TANK_TYPE:NEEDS[B9PartSwitch,!ConfigurableContainers,!Pathfinder,!ModularFuelTanks,!RealFuels]
{
	name = OPTLFO
	tankMass = 0.0003
	tankCost = 0.25
	RESOURCE
	{
		name = LiquidFuel
		unitsPerVolume = 0.45
	}
	RESOURCE
	{
		name = Oxidizer
		unitsPerVolume = 0.55
	}
}
B9_TANK_TYPE:NEEDS[B9PartSwitch,!ConfigurableContainers,!Pathfinder,!ModularFuelTanks,!RealFuels]
{
	name = OPTOX
	tankMass = 0.0003
	tankCost = 0.25
	RESOURCE
	{
		name = Oxidizer
		unitsPerVolume = 1
	}
}
B9_TANK_TYPE:NEEDS[B9PartSwitch,!ConfigurableContainers,!Pathfinder,!ModularFuelTanks,!RealFuels]
{
	name = OPTMONO
	tankMass = 0.0003
	tankCost = 0.75
	RESOURCE
	{
		name = MonoPropellant
		unitsPerVolume = 1.5
	}
}
B9_TANK_TYPE:NEEDS[B9PartSwitch]
{
	name = OPTAB
	tankMass = 0.0003
	tankCost = 0.5
	RESOURCE
	{
		name = Ablator
		unitsPerVolume = 1
	}
}
B9_TANK_TYPE:NEEDS[B9PartSwitch,!ConfigurableContainers,Kerbalism|NearFuturePropulsion,!ModularFuelTanks,!RealFuels]
{
	name = OPTXE
	tankMass = 0.0003
	tankCost = 0.25
	RESOURCE
	{
		name = XenonGas
		unitsPerVolume = 100
	}
}

// =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  
// Create fuel module
@PART:HAS[#manufacturer[OPT*Division],#refVolume[*]]:NEEDS[B9PartSwitch,!ConfigurableContainers,!Pathfinder,!ModularFuelTanks,!RealFuels]
{
	MODULE
	{
		name = ModuleB9PartSwitch
		moduleID = #$../TankTag$
		switcherDescription = OPT Tank
		switcherDescriptionPlural = Tank Selections
		switchInFlight = True
		baseVolume = #$../refVolume$
	}
}


// =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  
// Apply subtypes
@PART:HAS[#manufacturer[OPT*Division],@MODULE[ModuleB9PartSwitch]]:NEEDS[B9PartSwitch,!ConfigurableContainers,!Pathfinder,!ModularFuelTanks,!RealFuels]
{
	// Cockpits, drone cores and docking ports
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[OPTcmd]]
	{
		SUBTYPE
		{
			name = MO
			tankType = OPTMONO
			title = MonoPropellant
		}
		SUBTYPE
		{
			name = LF
			tankType = OPTLF
			title = LiquidFuel
		}
		SUBTYPE
		{
			name = LFO
			tankType = OPTLFO
			title = Kerolox
		}
		SUBTYPE
		{
			name = OX
			tankType = OPTOX
			title = Oxidizer
		}
		SUBTYPE
		{
			name = Structural
			title = Structural
			switchInFlight = False
		}
		SUBTYPE:NEEDS[Kerbalism|NearFuturePropulsion]
		{
			name = XE
			tankType = OPTXE
			title = XenonGas
		}
	}
	
	// Cabins
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[OPTcabin]]
	{
		SUBTYPE
		{
			name = LF
			tankType = OPTLF
			title = LiquidFuel
		}
		SUBTYPE
		{
			name = LFO
			tankType = OPTLFO
			title = Kerolox
		}
		SUBTYPE
		{
			name = OX
			tankType = OPTOX
			title = Oxidizer
		}
		SUBTYPE
		{
			name = MO
			tankType = OPTMONO
			title = MonoPropellant
		}
		SUBTYPE
		{
			name = Structural
			title = Structural
			switchInFlight = False
		}
		SUBTYPE
		{
			name = BATT
			tankType = Battery
			title = ElectricCharge
			switchInFlight = False
		}
		SUBTYPE:NEEDS[Kerbalism|NearFuturePropulsion]
		{
			name = XE
			tankType = OPTXE
			title = XenonGas
		}
	}
	
	// Majority body parts
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[OPTbody]]
	{
		SUBTYPE
		{
			name = LF
			tankType = OPTLF
			title = LiquidFuel
		}
		SUBTYPE
		{
			name = LFO
			tankType = OPTLFO
			title = Kerolox
		}
		SUBTYPE
		{
			name = OX
			tankType = OPTOX
			title = Oxidizer
		}
		SUBTYPE
		{
			name = MO
			tankType = OPTMONO
			title = MonoPropellant
		}
		SUBTYPE
		{
			name = Structural
			title = Structural
			switchInFlight = False
		}
		SUBTYPE
		{
			name = BATT
			tankType = Battery
			title = ElectricCharge
			switchInFlight = False
		}
		SUBTYPE:NEEDS[Kerbalism|NearFuturePropulsion]
		{
			name = XE
			tankType = OPTXE
			title = XenonGas
		}
	}
	// Cargo ramps and aero tails
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[OPTtail]]
	{
		SUBTYPE
		{
			name = LF
			tankType = OPTLF
			title = LiquidFuel
		}
		SUBTYPE
		{
			name = LFO
			tankType = OPTLFO
			title = Kerolox
		}
		SUBTYPE
		{
			name = OX
			tankType = OPTOX
			title = Oxidizer
		}
		SUBTYPE
		{
			name = MO
			tankType = OPTMONO
			title = MonoPropellant
		}
		SUBTYPE
		{
			name = Structural
			title = Structural
			switchInFlight = False
		}
		SUBTYPE
		{
			name = BATT
			tankType = Battery
			title = ElectricCharge
			switchInFlight = False
		}
		SUBTYPE:NEEDS[Kerbalism|NearFuturePropulsion]
		{
			name = XE
			tankType = OPTXE
			title = XenonGas
		}
	}
	// Wings
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[OPTwing]]
	{
		SUBTYPE
		{
			name = LF
			tankType = OPTLF
			title = LiquidFuel
		}
		SUBTYPE
		{
			name = LFO
			tankType = OPTLFO
			title = Kerolox
		}
		SUBTYPE
		{
			name = OX
			tankType = OPTOX
			title = Oxidizer
		}
		SUBTYPE
		{
			name = MO
			tankType = OPTMONO
			title = MonoPropellant
		}
		SUBTYPE
		{
			name = Structural
			title = Structural
			switchInFlight = False
		}
		SUBTYPE
		{
			name = BATT
			tankType = Battery
			title = ElectricCharge
			switchInFlight = False
		}
		SUBTYPE:NEEDS[Kerbalism|NearFuturePropulsion]
		{
			name = XE
			tankType = OPTXE
			title = XenonGas
		}
	}
	
	// Cargo bays, hollow parts not including ramps and aero tails
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[OPTcargo]]
	{
		SUBTYPE
		{
			name = LF
			tankType = OPTLF
			title = LiquidFuel
		}
		SUBTYPE
		{
			name = LFO
			tankType = OPTLFO
			title = Kerolox
		}
		SUBTYPE
		{
			name = OX
			tankType = OPTOX
			title = Oxidizer
		}
		SUBTYPE
		{
			name = MO
			tankType = OPTMONO
			title = MonoPropellant
		}
		SUBTYPE
		{
			name = Structural
			title = Structural
			switchInFlight = False
		}
		SUBTYPE
		{
			name = BATT
			tankType = Battery
			title = ElectricCharge
			switchInFlight = False
		}
		SUBTYPE:NEEDS[Kerbalism|NearFuturePropulsion]
		{
			name = XE
			tankType = OPTXE
			title = XenonGas
		}
	}
	
	// see OPT_Reconfig/CRP/OPT_RCS_toggles.cfg for SAS tank config
	
	// Drop tanks
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[OPTdrop]]
	{
		SUBTYPE
		{
			name = LF
			tankType = OPTLF
			title = LiquidFuel
			transform = LiquidFuel
		}
		SUBTYPE
		{
			name = OX
			tankType = OPTOX
			title = Oxidizer
			transform = Oxidizer
		}
	}
}

@PART[OPTdropTank]:NEEDS[B9PartSwitch]
{
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[OPTdrop]]
	{
		@SUBTYPE[LF]
		{
			volumeAdded = -27
		}
		@SUBTYPE[OX]
		{
			volumeAdded = 27
		}
	}
}

@PART[OPTdropTank2]:NEEDS[B9PartSwitch]
{
	@MODULE[ModuleB9PartSwitch]:HAS[#moduleID[OPTdrop]]
	{
		@SUBTYPE[LF]
		{
			volumeAdded = -54
		}
		@SUBTYPE[OX]
		{
			volumeAdded = 54
		}
	}
}
// =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  =  
// Apply mesh transforms
@PART[b_4m_tanks]:AFTER[OPT_Reconfig]
{
	@MODULE[ModuleB9PartSwitch]
	{
		@SUBTYPE,0
		{
			transform = LiquidFuelTank
		}
		@SUBTYPE,1
		{
			transform = LFOTank
		}
		@SUBTYPE,2
		{
			transform = LiquidFuelTank
		}
		@SUBTYPE,3
		{
			transform = LiquidFuelTank
		}
		@SUBTYPE,*:HAS[~transform[*]]
		{
			transform = Structure
		}
	}
}
@PART[b2_4m_adaptor_variant]:AFTER[OPT_Reconfig]
{
	@MODULE[ModuleB9PartSwitch]
	{
		@SUBTYPE,0
		{
			transform = LF
		}
		@SUBTYPE,1
		{
			transform = LFO
		}
		@SUBTYPE,2
		{
			transform = LF
		}
		@SUBTYPE,3
		{
			transform = LF
		}
		@SUBTYPE,*:HAS[~transform[*]]
		{
			transform = Structure
		}
	}
}

// Disable extra meshes when fuel switchers other than B9PS present
@PART[b_4m_tanks]:NEEDS[Pathfinder|ModularFuelTanks|RealFuels]
{
	MODULE
	{
		name = ModuleB9DisableTransform
		transform = LiquidFuelTank
		transform = Structure
	}
}
@PART[OPTdropTank*]:NEEDS[Pathfinder|ModularFuelTanks|RealFuels]
{
	MODULE
	{
		name = ModuleB9DisableTransform
		transform = Oxidizer
	}
}
@PART[b2_4m_adaptor_variant]:NEEDS[Pathfinder|ModularFuelTanks|RealFuels]
{
	MODULE
	{
		name = ModuleB9DisableTransform
		transform = LF
		transform = Structure
	}
}
